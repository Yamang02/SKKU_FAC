<style>
    @import url('/css/admin/management/user/UserManagementList.css');
</style>

<div class="admin-management">
    <h2 class="admin-title">회원목록</h2>

    <!-- 컨트롤 섹션 -->
    <div class="admin-control">
        <div class="admin-control__group">
            <button class="admin-button admin-button--primary" onclick="location.href='/admin/management/user/create'">
                <i class="fas fa-plus"></i>
                회원 등록
            </button>
        </div>
    </div>

    <!-- 필터 섹션 -->
    <div class="admin-filter">
        <div class="admin-filter__group">
            <select class="admin-filter__select" name="status">
                <option value="">회원 상태</option>
                <option value="active" <%=filters?.status==='active' ? 'selected' : '' %>>활성</option>
                <option value="inactive" <%=filters?.status==='inactive' ? 'selected' : '' %>>비활성</option>
                <option value="suspended" <%=filters?.status==='suspended' ? 'selected' : '' %>>정지</option>
            </select>
            <select class="admin-filter__select" name="role">
                <option value="">회원 역할</option>
                <option value="admin" <%=filters?.role==='admin' ? 'selected' : '' %>>관리자</option>
                <option value="artist" <%=filters?.role==='artist' ? 'selected' : '' %>>작가</option>
                <option value="club_member" <%=filters?.role==='club_member' ? 'selected' : '' %>>동아리 회원</option>
                <option value="guest" <%=filters?.role==='guest' ? 'selected' : '' %>>게스트</option>
            </select>
            <input type="text" class="admin-filter__input" name="keyword" placeholder="검색어"
                value="<%= filters?.keyword || '' %>">
            <button class="admin-button admin-button--primary" id="btnApplyFilter">
                <i class="fas fa-filter"></i>
                필터 적용
            </button>
        </div>
    </div>

    <div class="admin-management__content">
        <!-- 테이블 섹션 -->
        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" class="admin-checkbox">
                        </th>
                        <th>ID</th>
                        <th>역할</th>
                        <th>이름</th>
                        <th>학번</th>
                        <th>이메일</th>
                        <th>가입일</th>
                        <th>수정일</th>
                        <th>상태</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (users && users.length> 0) { %>
                        <% users.forEach(user=> { %>
                            <tr>
                                <td>
                                    <input type="checkbox" class="admin-checkbox">
                                </td>
                                <td>
                                    <%= user.username %>
                                </td>
                                <td>
                                    <span class="admin-badge admin-badge--<%= user.role.toLowerCase() %>">
                                        <%= user.role==='ADMIN' ? '관리자' : user.role==='ARTIST' ? '작가' :
                                            user.role==='CLUB_MEMBER' ? '동아리 회원' : '게스트' %>
                                    </span>
                                </td>
                                <td>
                                    <%= user.name %>
                                </td>
                                <td>
                                    <%= user.studentId || '-' %>
                                </td>
                                <td>
                                    <%= user.email %>
                                </td>
                                <td>
                                    <%= new Date(user.createdAt).toLocaleDateString() %>
                                </td>
                                <td>
                                    <%= new Date(user.updatedAt).toLocaleDateString() %>
                                </td>
                                <td>
                                    <span
                                        class="admin-badge admin-badge--<%= user.status ? user.status.toLowerCase() : 'active' %>">
                                        <%= user.status || 'ACTIVE' %>
                                    </span>
                                </td>
                                <td>
                                    <div class="admin-button-group">
                                        <a href="/admin/management/user/<%= user.id %>"
                                            class="admin-button admin-button--secondary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="admin-button admin-button--danger"
                                            onclick="toggleUserStatus('<%= user.id %>', '<%= user.status || 'ACTIVE' %>')">
                                            <i class="fas fa-ban"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="10" class="admin-table__empty">
                                            등록된 회원이 없습니다.
                                        </td>
                                    </tr>
                                    <% } %>
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 섹션 -->
        <div class="admin-pagination">
            <% if (typeof page !=='undefined' && page) { %>
                <button class="admin-pagination__button" onclick="goToPage(1)">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button class="admin-pagination__button" onclick="goToPage(<%= page.currentPage - 1 %>)"
                    <%=!page.hasPreviousPage ? 'disabled' : '' %>>
                    <i class="fas fa-angle-left"></i>
                </button>

                <% for (let i=Math.max(1, page.currentPage - 2); i <=Math.min(page.totalPages, page.currentPage + 2);
                    i++) { %>
                    <button
                        class="admin-pagination__button <%= i === page.currentPage ? 'admin-pagination__button--active' : '' %>"
                        onclick="goToPage(<%= i %>)">
                        <%= i %>
                    </button>
                    <% } %>

                        <button class="admin-pagination__button" onclick="goToPage(<%= page.currentPage + 1 %>)"
                            <%=!page.hasNextPage ? 'disabled' : '' %>>
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="admin-pagination__button" onclick="goToPage(<%= page.totalPages %>)">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                        <% } %>
        </div>
    </div>
</div>

<script>
    function toggleUserStatus(id, currentStatus) {
        const newStatus = currentStatus === 'ACTIVE' ? 'SUSPENDED' : 'ACTIVE';
        const confirmMessage = newStatus === 'SUSPENDED' ?
            '정말로 이 회원을 정지하시겠습니까?' : '정말로 이 회원의 정지를 해제하시겠습니까?';

        if (confirm(confirmMessage)) {
            fetch(`/admin/management/user/${id}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            }).then(response => {
                if (response.ok) {
                    alert('회원 상태가 성공적으로 변경되었습니다.');
                    window.location.reload();
                } else {
                    alert('회원 상태 변경 중 오류가 발생했습니다.');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('회원 상태 변경 중 오류가 발생했습니다.');
            });
        }
    }

    function goToPage(page) {
        const currentUrl = new URL(window.location.href);
        const searchParams = currentUrl.searchParams;
        searchParams.set('page', page);
        window.location.href = currentUrl.toString();
    }

    document.getElementById('btnApplyFilter').addEventListener('click', function () {
        const status = document.querySelector('select[name="status"]').value;
        const role = document.querySelector('select[name="role"]').value;
        const keyword = document.querySelector('input[name="keyword"]').value;

        const currentUrl = new URL(window.location.href);
        const searchParams = currentUrl.searchParams;

        if (status) {
            searchParams.set('status', status);
        } else {
            searchParams.delete('status');
        }

        if (role) {
            searchParams.set('role', role);
        } else {
            searchParams.delete('role');
        }

        if (keyword) {
            searchParams.set('keyword', keyword);
        } else {
            searchParams.delete('keyword');
        }

        searchParams.set('page', 1);
        window.location.href = currentUrl.toString();
    });
</script>
